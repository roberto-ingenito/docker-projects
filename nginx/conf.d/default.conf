# Redirect da HTTP a HTTPS
server {
    listen 80;
    server_name roberto-ingenito.ddns.net;

    # Gestione challenge Let's Encrypt
    location /.well-known/acme-challenge/ { 
        root /var/www/certbot;
    }

    # Redirect a HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ===============================================
# SERVER HTTPS UNICO - PORTA 443
# ===============================================
server {
    listen 443 ssl;
    http2 on;
    server_name roberto-ingenito.ddns.net;

    # Includi i parametri SSL condivisi
    include /etc/nginx/conf.d/ssl_params.conf;
    
    client_max_body_size 100M;

    # ===============================================
    # BACKEND API - /api/
    # IMPORTANTE: Deve essere PRIMA di /cashly
    # ===============================================
    location /api/ {
        proxy_pass http://cashly-back-end:80/api/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Prefix /api;
    }

    # Swagger UI
    location /swagger {
        proxy_pass http://cashly-back-end:80/swagger;
        
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ===============================================
    # FORTIL TIMESHEET SPA - /timesheet/
    # ===============================================
    location /timesheet/ {
        proxy_pass http://fortil-excel-timesheet-app:5002/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Prefix /timesheet;
    }

    # ===============================================
    # CASHLY FRONTEND - Tutto sotto /cashly/
    # IMPORTANTE: Un solo location per tutto Next.js
    # ===============================================
    location /cashly/ {
        # MANTIENI il path completo con /cashly/
        proxy_pass http://cashly-front-end:3000/cashly/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_cache_bypass $http_upgrade;
        
        # Cache per assets statici _next
        # location ~ ^/cashly/_next/static/ {
        #     proxy_pass http://cashly-front-end:3000;
        #     expires 365d;
        #     add_header Cache-Control "public, immutable";
        # }
    }

    # ===============================================
    # ROOT PATH - Redirect
    # ===============================================
    location = / {
        # Redirect al frontend
        return 301 /cashly/;
    }

    # Blocca tutto il resto (opzionale)
    location / {
        return 404;
    }
}