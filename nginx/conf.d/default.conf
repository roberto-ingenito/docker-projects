# Redirect da HTTP a HTTPS
server {
    listen 80;
    server_name roberto-ingenito.ddns.net;

    # Gestione challenge Let's Encrypt
    location /.well-known/acme-challenge/ { 
        root /var/www/certbot;
    }

    # Redirect a HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ===============================================
# SERVER HTTPS UNICO - PORTA 443
# ===============================================
server {
    listen 443 ssl;
    http2 on;
    server_name roberto-ingenito.ddns.net;

    # Includi i parametri SSL condivisi
    include /etc/nginx/conf.d/ssl_params.conf;
    
    client_max_body_size 10G;

    # ===============================================
    # NEXTCLOUD - /cloud/
    # ===============================================
    location /cloud/ {
        proxy_pass http://nextcloud-app:80/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Prefix /cloud;
        
        # Timeouts per upload grandi
        proxy_connect_timeout 3600;
        proxy_send_timeout 3600;
        proxy_read_timeout 3600;
        
        # Max upload size
        client_max_body_size 10G;
        client_body_buffer_size 400M;
    }

    # ===============================================
    # BACKEND API - /api/
    # IMPORTANTE: Deve essere PRIMA di /cashly
    # ===============================================
    location /api/ {
        proxy_pass http://cashly-back-end:80/api/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Prefix /api;
    }

    # Swagger UI
    location /swagger {
        proxy_pass http://cashly-back-end:80/swagger;
        
        include /etc/nginx/conf.d/proxy_params.conf;
    }

    # ===============================================
    # FORTIL TIMESHEET SPA - /timesheet/
    # ===============================================
    location /timesheet/ {
        proxy_pass http://fortil-excel-timesheet-app:3000/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Prefix /timesheet;
    }

    # ===============================================
    # PROMPT BUILDER SPA - /prompt-builder/
    # ===============================================
    location /prompt-builder/ {
        proxy_pass http://prompt-builder-app:3000/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_set_header X-Forwarded-Prefix /prompt-builder;
    }

    # ===============================================
    # CASHLY FRONTEND - Tutto sotto /cashly/
    # ===============================================

    # CASHLY SERVICE WORKER (SW)
    # Assicuriamo che il Service Worker sia servito da Next.js e abbia il Content-Type corretto
    location = /cashly/sw.js {
        proxy_pass http://cashly-front-end:3000/cashly/sw.js;

        # Assicura il tipo MIME corretto
        types {
            application/javascript js;
        }
        default_type application/javascript;

        # Evita che venga cachato in modo aggressivo dal proxy/browser (per gli aggiornamenti)
        expires off;
        add_header Cache-Control "no-cache, no-store, must-revalidate";

        include /etc/nginx/conf.d/proxy_params.conf;
    }
    
    location = /cashly/ {
        return 302 /cashly/dashboard;
    }

    location /cashly/ {
        # Cache per assets statici _next (DEVE essere prima del proxy_pass generale)
        location ~ ^/cashly/_next/static/ {
            proxy_pass http://cashly-front-end:3000;
            proxy_cache_valid 200 365d;
            expires 365d;
            add_header Cache-Control "public, immutable";
            
            # Headers essenziali
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        proxy_pass http://cashly-front-end:3000/cashly/;
        
        include /etc/nginx/conf.d/proxy_params.conf;
        
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port 443;
        proxy_cache_bypass $http_upgrade;
    }

    # ===============================================
    # ROOT PATH - Redirect
    # ===============================================
    location = / {
        # Redirect al frontend
        return 302 /cashly/;
    }

    # Blocca tutto il resto (opzionale)
    location / {
        return 404;
    }
}