# File: ./nginx/conf.d/default.conf
# Configurazione per multipli servizi su porte diverse

# Redirect da HTTP a HTTPS (solo per la porta 80 standard)
server {
    listen 80;
    server_name roberto-ingenito.ddns.net;

    # Gestione challenge Let's Encrypt (fondamentale per il rinnovo)
    location /.well-known/acme-challenge/ { 
        root /var/www/certbot;
    }

    # Redirect di tutto il resto a una porta HTTPS di default (es. 5000)
    location / {
        return 301 https://$server_name:5000$request_uri;
    }
}

# ===============================================
# SERVIZIO 1: CASHLY FRONTEND (PORTA 5000)
# ===============================================
server {
    listen 5000 ssl;
    http2 on;
    server_name _;

    # Includi i parametri SSL condivisi
    include /etc/nginx/conf.d/ssl_params.conf;
    
    client_max_body_size 100M;

    location / {
        proxy_pass http://front-end:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host:5000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header X-Forwarded-Host $host:5000;
        proxy_set_header X-Forwarded-Port 5000;
    }
}

# ===============================================
# SERVIZIO 2: CASHLY BACKEND + SWAGGER (PORTA 5001)
# ===============================================
server {
    listen 5001 ssl;
    http2 on;
    server_name _;

    # Includi i parametri SSL condivisi
    include /etc/nginx/conf.d/ssl_params.conf;
    
    client_max_body_size 100M;

    # Tutto il traffico su questa porta va al backend
    location / {
        proxy_pass http://back-end:80; # Passa al servizio backend
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}

# ===============================================
# SERVIZIO 3: FORTIL TIMESHEET (PORTA 5002)
# ===============================================
server {
    listen 5002 ssl;
    http2 on;
    server_name _;

    # Includi i parametri SSL condivisi
    include /etc/nginx/conf.d/ssl_params.conf;
    
    client_max_body_size 100M;

    location / {
        proxy_pass http://fortil-excel-timesheet:5002; # La porta interna del server preview di Vite
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
    }
}
