name: Self-Hosted Workflow

on:
  push:
    branches: [main]
    paths:
      - "cashly/front-end/**"
      - "cashly/back-end/**"
      - "nginx/**"
      - "fortil-excel-timesheet/**"
      - "mr-white-game/frontend/**"
      - "mr-white-game/backend/**"
  workflow_dispatch:
    inputs:
      service:
        description: "Service to deploy"
        required: true
        type: choice
        options:
          - all
          - cashly-frontend
          - cashly-backend
          - nginx
          - fortil-excel-timesheet
          - mr-white-frontend
          - mr-white-backend

jobs:
  check-changes:
    runs-on: self-hosted
    outputs:
      cashly-frontend: ${{ steps.filter.outputs.cashly-frontend == 'true' || github.event.inputs.service == 'cashly-frontend' || github.event.inputs.service == 'all' }}
      cashly-backend: ${{ steps.filter.outputs.cashly-backend == 'true' || github.event.inputs.service == 'cashly-backend' || github.event.inputs.service == 'all' }}
      nginx: ${{ steps.filter.outputs.nginx == 'true' || github.event.inputs.service == 'nginx' || github.event.inputs.service == 'all' }}
      fortil-excel-timesheet: ${{ steps.filter.outputs.fortil-excel-timesheet == 'true' || github.event.inputs.service == 'fortil-excel-timesheet' || github.event.inputs.service == 'all' }}
      mr-white-frontend: ${{ steps.filter.outputs.mr-white-frontend == 'true' || github.event.inputs.service == 'mr-white-frontend' || github.event.inputs.service == 'all' }}
      mr-white-backend: ${{ steps.filter.outputs.mr-white-backend == 'true' || github.event.inputs.service == 'mr-white-backend' || github.event.inputs.service == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name == 'push'
        with:
          filters: |
            cashly-frontend:
              - 'cashly/front-end/**'
            cashly-backend:
              - 'cashly/back-end/**'
            nginx:
              - 'nginx/**'
            fortil-excel-timesheet:
              - 'fortil-excel-timesheet/**'
            mr-white-frontend:
              - 'mr-white-game/frontend/**'
            mr-white-backend:
              - 'mr-white-game/backend/**'

  deploy-cashly-frontend:
    needs: check-changes
    if: needs.check-changes.outputs.cashly-frontend == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy cashly-frontend
        run: |
          docker compose build --no-cache cashly-front-end
          docker compose up -d cashly-front-end

      - name: Clean old images
        run: |
          docker image prune -f

  deploy-cashly-backend:
    needs: check-changes
    if: needs.check-changes.outputs.cashly-backend == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy cashly-backend
        run: |
          set -a
          source /mnt/storage/projects/docker-projects/.env
          set +a
          docker compose build --no-cache cashly-back-end
          docker compose up -d cashly-back-end

      - name: Clean old images
        run: |
          docker image prune -f

  deploy-nginx:
    needs: check-changes
    if: needs.check-changes.outputs.nginx == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Restart nginx
        run: |
          docker compose restart nginx

  deploy-fortil-timesheet:
    needs: check-changes
    if: needs.check-changes.outputs.fortil-excel-timesheet == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy fortil-excel-timesheet
        run: |
          docker compose build --no-cache fortil-excel-timesheet
          docker compose up -d fortil-excel-timesheet

      - name: Clean old images
        run: |
          docker image prune -f

  deploy-mr-white-backend:
    needs: check-changes
    if: needs.check-changes.outputs.mr-white-backend == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy mr-white-backend
        run: |
          docker compose build --no-cache mr-white-back-end
          docker compose up -d mr-white-back-end

      - name: Clean old images
        run: |
          docker image prune -f

  deploy-mr-white-frontend:
    needs: check-changes
    if: needs.check-changes.outputs.mr-white-frontend == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Deploy mr-white-frontend
        run: |
          docker compose build --no-cache mr-white-front-end
          docker compose up -d mr-white-front-end

      - name: Clean old images
        run: |
          docker image prune -f
